
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Abdulrahman Altahhan, 2025">
      
      
      
        <link rel="prev" href="../lesson13/lesson13.html">
      
      
        <link rel="next" href="../../unit5/lesson15/lesson15.html">
      
      
      <link rel="icon" href="../../img/favicon.jpg">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.4">
    
    
      
        <title>14. Linear Approximation for Control - Reinforcement Learning and Robotics</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8608ea7d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lesson-13-action-value-approximation-and-policy-gradient-methods-for-control" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
            
    <div id="versionIndicator"><b>Version:</b> 04.06.21.a</div>
    <img id="customlogo" src="../../img/logo.svg" alt="University of Leeds logo.">

          </div>
          
        </aside>
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../index.html" title="Reinforcement Learning and Robotics" class="md-header__button md-logo" aria-label="Reinforcement Learning and Robotics" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Reinforcement Learning and Robotics
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              14. Linear Approximation for Control
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../index.html" class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../unit1/lesson1/lesson1.html" class="md-tabs__link">
          
  
  Unit 1

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../unit2/lesson5/lesson5.html" class="md-tabs__link">
          
  
  Unit 2

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../unit3/lesson8/lesson8.html" class="md-tabs__link">
          
  
  Unit 3

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../lesson12/lesson12.html" class="md-tabs__link">
          
  
  Unit 4

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../unit5/lesson15/lesson15.html" class="md-tabs__link">
          
  
  Unit 5

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../unit6/lesson18/lesson18.html" class="md-tabs__link">
          
  
  Unit 6

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../index.html" title="Reinforcement Learning and Robotics" class="md-nav__button md-logo" aria-label="Reinforcement Learning and Robotics" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Reinforcement Learning and Robotics
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../index.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Unit 1
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Unit 1
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../unit1/lesson1/lesson1.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. Tabular Methods
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../unit1/lesson2/lesson2.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. K-Arm Bandit
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../unit1/lesson3/lesson3.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. MDP
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../unit1/lesson4/lesson4.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4. ROS
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Unit 2
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Unit 2
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../unit2/lesson5/lesson5.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5. Dynamic Programming
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../unit2/lesson6/lesson6.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6. Monte Carlo
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../unit2/lesson7/lesson7.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7. Mobile Robots
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Unit 3
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Unit 3
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../unit3/lesson8/lesson8.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8. Temporal Difference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../unit3/lesson9/lesson9.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9. n-Step Methods
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../unit3/lesson10/lesson10.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    10. Planning in RL(optional)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../unit3/lesson11/lesson11.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    11. Localisation and SLAM
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Unit 4
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Unit 4
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lesson12/lesson12.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    12. Function Approximation Methods
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lesson13/lesson13.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    13. Linear Approximation for Prediction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="lesson14.html" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    14. Linear Approximation for Control
    
  </span>
  

      </a>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Unit 5
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Unit 5
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../unit5/lesson15/lesson15.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    15. Linear Approximation with Eligibility Traces(prediction and control)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../unit5/lesson16/lesson16.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    16. Nonlinear Approximation for Control
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../unit5/lesson17/lesson17.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    17. Application on Robot Navigation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Unit 6
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Unit 6
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../unit6/lesson18/lesson18.html" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    18. Application on Games(optional)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<p>The notebook uses a library of functionality in RL that aims for simplicity and general insight into how algorithms work, these libraries are written from scratch using standard Python libraries (numpy, matplotlib etc.).
Please note that you will need permission from the author to use the code for research, commercially or otherwise.</p>
<h1 id="lesson-13-action-value-approximation-and-policy-gradient-methods-for-control">Lesson 13: Action-Value Approximation and Policy Gradient Methods for Control</h1>
<p><strong>Learning outcomes</strong>
1. understand how to generalize tabular control methods to function approximation methods
1. understand how to generalize tabular policy methods to policy approximation methods
1. understand how to using tile coding for a continuous control problem
1. understand the difference between additive and multiplicative representation
1. understand how to take advantage of binary representation to come up with a binary control algorithm-namely Binary Sarsa
1. understand the benefit of using hashing along the side with tile coding and the added benefit of using index hash table</p>
<p><strong>Reading</strong>:
The accompanying reading of this lesson is <strong>chapters 10 and 12</strong> of our text book available online <a href="http://incompleteideas.net/book/RLbook2020.pdf">here</a>. Please note that we explain the ideas of this topic from a practical perspective and not from a theoretical perspective which is already covered in the textbook.</p>
<p>In this lesson, we continue our coverage of algorithms that use function approximation, this time for control. We use tile coding again, but this time in the context of an underpowered car that needs to climb a mountain. In susequent lessons, we then move to a set of powerful techniques that utilise the idea of eligibility traces, which allow an algorithm to perform updates that mimic the effect of a set of n-steps updates without having to wait for n-steps! We then move to cover RL algorithms that are suitable for Robotics and Games, which utilise non-linear function approximation, particularly neural networks shallow and deep, such as DQN and DDQN.</p>
<p>So far, we have not tackled any task that has a continuous state space; rather all the state spaces that we have come across were discrete. In this lesson, we will see how to apply the tile coding technique we covered in the previous lesson on a continuous <em>control</em> task. The task will be controlling an underpowered vehicle stuck between two hills. We want our car to successfully negotiate this terrain and reach the right hilltop. Along the way, we will develop a new binary algorithm, Binary Sarsa, that is suitable for dealing with binary encoding, and we will study its performance. We present three representations of the problem. The first just discretised the space and used a vector representation that corresponds with this discretisation. This representation is equivalent to using one tiling in tile coding. Then we develop this representation to use multiple tiling that offset each other to enrich the representation capability for our continuous space. We then try to reduce the extra overhead introduced by the tile coding using hashing. We show two types of hashing, one that uses raw hashing via the modulus % operator and one that uses an index hashing table, which guarantees correspondence with non-hashed tile coding when the table is large enough.
Ok let us get started...</p>
<div class="highlight"><pre><span></span><code><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">rl.rlln</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">floor</span>
</code></pre></div>
<style>.container {width:90% !important}</style>

<p>Note that we imported the Grid and the other environments from the Function approximation lesson because we are dealing with vectorised environment form now on.</p>
<h1 id="control-with-function-approximation">Control with Function approximation</h1>
<h2 id="mdp-with-linear-function-approximation">MDP with <em>Linear</em> Function Approximation</h2>
<p>Below we show the implementation of the new MDP class. We have set it up in a way that allows us to maintain the same structure of the different updates that uses Q values. Note that we assign the new self.Q to the function self.Q_ which makes self.Q a function and then we can call self.Q(s,a) to obtain the Q values for state s and action a.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">vMDP</span><span class="p">(</span><span class="n">MDP</span><span class="p">(</span><span class="n">vMRP</span><span class="p">)):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">nA</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">nF</span><span class="p">))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">q0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q_</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Q_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1">#print(s.shape)</span>
        <span class="n">W</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">W</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">S_</span><span class="p">())</span><span class="o">.</span><span class="n">T</span> 

    <span class="c1"># we should have used ∇ but python does not like it</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ΔQ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span> 
        <span class="k">return</span> <span class="n">s</span>
</code></pre></div>
<p>Below we make sure that the classes hierarchy is correct by double-checking that the policy of an MDP object is εgreedy.</p>
<div class="highlight"><pre><span></span><code><span class="n">vMDP</span><span class="p">()</span><span class="o">.</span><span class="n">policy</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;bound method MDP.&lt;locals&gt;.MDP.εgreedy of &lt;__main__.vMDP object at 0x127e58b60&gt;&gt;
</code></pre></div>
<h2 id="offline-mcc-with-any-function-approximation">Offline MCC with Any Function Approximation</h2>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MCC</span><span class="p">(</span><span class="n">vMDP</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># ---------------------------- 🌘 offline, MC learning: end-of-episode learning-----------------------    </span>
    <span class="k">def</span><span class="w"> </span><span class="nf">offline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
        <span class="c1"># obtain the return for the latest episode</span>
        <span class="n">Gt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
            <span class="n">rn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">Gt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">γ</span><span class="o">*</span><span class="n">Gt</span> <span class="o">+</span> <span class="n">rn</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">α</span><span class="o">*</span><span class="p">(</span><span class="n">Gt</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">a</span><span class="p">))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ΔQ</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">mc</span> <span class="o">=</span> <span class="n">MCC</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">vgrid</span><span class="p">(</span><span class="n">reward</span><span class="o">=</span><span class="s1">&#39;reward100&#39;</span><span class="p">),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">demoQ</span><span class="p">())</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_15_0.png" /></p>
<h2 id="online-sarsa-with-any-function-approximation">Online Sarsa with Any Function Approximation</h2>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Sarsa</span><span class="p">(</span><span class="n">vMDP</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1">#α=.8</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_an</span> <span class="c1"># for Sarsa we want to decide the next action in time step t</span>

    <span class="c1"># ----------------------------------------🌖 online learning ----------------------------------------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">online</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">rn</span><span class="p">,</span><span class="n">sn</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span><span class="n">an</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">α</span><span class="o">*</span><span class="p">(</span><span class="n">rn</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">done</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">γ</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span><span class="n">an</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">a</span><span class="p">))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ΔQ</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">sarsa</span> <span class="o">=</span> <span class="n">Sarsa</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">vgrid</span><span class="p">(</span><span class="n">reward</span><span class="o">=</span><span class="s1">&#39;reward1&#39;</span><span class="p">),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">demoQ</span><span class="p">())</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_18_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">sarsa</span><span class="o">.</span><span class="n">Q_</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>array([-32.256     , -33.9072    , -27.2128    , -24.5888    ,
       -16.32      ,  -8.        ,  -8.        ,   0.        ,
         0.        ,   0.        , -41.189888  , -33.6       ,
       -27.4432    , -24.64      , -17.6       ,  -9.6       ,
        -8.        ,  -8.        ,   0.        ,  -8.        ,
       -39.7592576 , -35.354112  , -29.29706435, -19.989784  ,
        -9.99998879,  -0.32      ,   0.        ,   0.        ,
         0.        ,   0.        , -41.7846272 , -46.20985139,
       -27.0091264 , -24.335872  , -16.144384  ,  10.        ,
         0.        ,  -8.        ,  -8.        ,  -8.        ,
       -39.0272    , -37.9008    , -24.256     , -18.88      ,
       -11.586048  ,  -9.6       ,  -8.        ,   0.        ,
         0.        ,   0.        , -33.28      , -32.83456   ,
       -28.46976   , -24.97024   , -20.1728    , -11.2       ,
        -8.        ,   0.        ,   0.        ,   0.        ,
       -34.0992    , -26.6368    , -22.976     , -24.512     ,
       -25.6128    , -28.16      ,  -8.        ,   0.        ,
         0.        ,   0.        , -28.3648    , -32.4608    ,
       -26.18624   , -27.0976    , -18.88      , -16.        ,
       -14.4       ,   0.        ,   0.        ,   0.        ])
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">example_6_5</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Sarsa</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">vwindy</span><span class="p">(</span><span class="n">reward</span><span class="o">=</span><span class="s1">&#39;reward1&#39;</span><span class="p">),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">170</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="o">**</span><span class="n">demoQ</span><span class="p">())</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;TD on Windy&#39;</span><span class="p">)</span>

<span class="n">trainedV</span> <span class="o">=</span> <span class="n">example_6_5</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">133</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trainedV</span><span class="o">.</span><span class="n">Ts</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(),</span> <span class="nb">range</span><span class="p">(</span><span class="n">trainedV</span><span class="o">.</span><span class="n">episodes</span><span class="p">),</span><span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;cumulative steps&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_20_0.png" /></p>
<h2 id="q-learning-with-function-approximation">Q-learning with Function Approximation</h2>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Qlearn</span><span class="p">(</span><span class="n">vMDP</span><span class="p">):</span>
<span class="c1"># 🕹️ 𖡄 </span>
    <span class="c1">#--------------------------------------🌖 online learning --------------------------------------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">online</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">rn</span><span class="p">,</span><span class="n">sn</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">α</span><span class="o">*</span><span class="p">(</span><span class="n">rn</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">done</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">γ</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">sn</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">a</span><span class="p">))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ΔQ</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">qlearn</span> <span class="o">=</span> <span class="n">Qlearn</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">vgrid</span><span class="p">(),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span> <span class="n">γ</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">demoQ</span><span class="p">())</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_23_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">qlearn</span> <span class="o">=</span> <span class="n">Qlearn</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">vgrid</span><span class="p">(</span><span class="n">reward</span><span class="o">=</span><span class="s1">&#39;reward1&#39;</span><span class="p">),</span> <span class="n">γ</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">α</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">demoQ</span><span class="p">())</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_24_0.png" /></p>
<h2 id="sarsa-and-q-learning-on-the-cliff">Sarsa and Q-Learning on the Cliff!</h2>
<div class="highlight"><pre><span></span><code><span class="n">sarsa</span> <span class="o">=</span> <span class="n">Sarsa</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">vcliffwalk</span><span class="p">(),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">demoR</span><span class="p">())</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_26_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">sarsa</span> <span class="o">=</span> <span class="n">Qlearn</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">vcliffwalk</span><span class="p">(),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">demoR</span><span class="p">())</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_27_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">SarsaCliff</span><span class="p">,</span> <span class="n">QlearnCliff</span> <span class="o">=</span> <span class="n">example_6_6</span><span class="p">(</span><span class="n">runs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">vcliffwalk</span><span class="p">(),</span> <span class="n">alg1</span><span class="o">=</span><span class="n">Sarsa</span><span class="p">,</span> <span class="n">alg2</span><span class="o">=</span><span class="n">Qlearn</span><span class="p">)</span><span class="c1"># runs=500</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
</code></pre></div>
<p><img alt="png" src="output_28_1.png" /></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">XSarsa</span><span class="p">(</span><span class="n">vMDP</span><span class="p">):</span>

    <span class="c1"># ------------------------------------- 🌖 online learning --------------------------------------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">online</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">rn</span><span class="p">,</span><span class="n">sn</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">):</span>      
        <span class="c1"># obtain the ε-greedy policy probabilities, then obtain the expecation via a dot product for efficiency</span>
        <span class="n">π</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">(</span><span class="n">sn</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">sn</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">π</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">α</span><span class="o">*</span><span class="p">(</span><span class="n">rn</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">done</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">γ</span><span class="o">*</span><span class="n">v</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">a</span><span class="p">))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ΔQ</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">xsarsa</span> <span class="o">=</span> <span class="n">XSarsa</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">vmaze</span><span class="p">(),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">γ</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">demoQ</span><span class="p">())</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_30_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">xsarsa</span> <span class="o">=</span> <span class="n">XSarsa</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">vcliffwalk</span><span class="p">(),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">γ</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">plotT</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_31_0.png" /></p>
<h2 id="one-hot-encoding-with-redundant-features-for-control">One-hot-encoding with redundant features for control</h2>
<div class="highlight"><pre><span></span><code><span class="n">sarsa</span> <span class="o">=</span> <span class="n">Sarsa</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">vmaze</span><span class="p">(</span><span class="n">nF</span><span class="o">=</span><span class="mi">160</span><span class="p">,</span> <span class="n">reward</span><span class="o">=</span><span class="s1">&#39;reward1&#39;</span><span class="p">),</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="o">**</span><span class="n">demoQ</span><span class="p">())</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_33_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">sarsa</span><span class="o">.</span><span class="n">store</span><span class="o">=</span><span class="kc">True</span>
<span class="n">sarsa</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>&lt;__main__.Sarsa at 0x129fabd70&gt;
</code></pre></div>
<p><img alt="png" src="output_34_1.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">sarsa</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>array([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
       0, 0, 0, 0, 0, 0], dtype=uint32)
</code></pre></div>
<p>Note how we have almost 100 extra redundant features that will never be turned on. The point of doing such thing is to double check that our infrastructure is capable of accommodating different features sizes and is not tied to a feature representation that has the same size of the state space.</p>
<h2 id="policy-gradient-methods-with-function-approximation">Policy Gradient Methods with Function Approximation</h2>
<p>We turn out attention now to develop an actor-critic algorithm that uses function approximation. Note that as we said earlier the actor part uses control updates similar to Sarsa or Q learning while the critic part uses TD prediction updates. Hence, writing our algorithm is straightforward because we have already developed the infra-structure for both prediction and control.</p>
<p>Note that if you have not read the policy gradient methods in lesson 4 and 5. It is now time to go back and read the corresponding sections. The ideas of policy gradient method are covered in chapter 13 of our book.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Actor_Critic</span><span class="p">(</span><span class="n">PG</span><span class="p">(</span><span class="n">vMDP</span><span class="p">)):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">step0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">γt</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># powers of γ</span>

    <span class="c1"># -------------------------------------- 🌖 online learning ------------------------------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">online</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">rn</span><span class="p">,</span><span class="n">sn</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span><span class="n">_</span><span class="p">):</span> 
        <span class="n">π</span><span class="p">,</span> <span class="n">γ</span><span class="p">,</span> <span class="n">γt</span><span class="p">,</span> <span class="n">α</span><span class="p">,</span> <span class="n">τ</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">ΔV</span><span class="p">,</span> <span class="n">ΔQ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">π</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">γ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">γt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">α</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">τ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ΔV</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ΔQ</span>

        <span class="n">δ</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span> <span class="n">done</span><span class="p">)</span><span class="o">*</span><span class="n">γ</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="n">sn</span><span class="p">)</span> <span class="o">+</span> <span class="n">rn</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>    <span class="c1"># TD error is based on the critic estimate</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w</span>    <span class="o">+=</span> <span class="n">α</span><span class="o">*</span><span class="n">δ</span><span class="o">*</span><span class="n">ΔV</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>                         <span class="c1"># critic v</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">+=</span> <span class="n">α</span><span class="o">*</span><span class="n">δ</span><span class="o">*</span><span class="n">ΔQ</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">π</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">a</span><span class="p">))</span><span class="o">*</span><span class="n">γt</span><span class="o">/</span><span class="n">τ</span>       <span class="c1"># actor  </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">γt</span> <span class="o">*=</span> <span class="n">γ</span>  
</code></pre></div>
<p>Note that since we use a separate <span class="arithmatex">\(\theta_a\)</span> for each action, where we have that </p>
<p><span class="arithmatex">\(Q(s,a) = \phi^\top \theta_a \qquad\)</span> 
<span class="arithmatex">\(\pi(a|s,\theta_a) = \frac{e^{\phi^\top \theta_a}}{\sum_{b}{e^{\phi^\top \theta_b}}}\)</span></p>
<p>then equation 13.9 becomes as follows</p>
<p><span class="arithmatex">\(\nabla_{\theta_a} ln \pi(a|s,\theta_a) = \phi (1-  \pi(a))\)</span></p>
<p>In the book authors assumes that we are using a concatenated vector <span class="arithmatex">\(\theta\)</span> for all actions where each n weights represents one of the actions.</p>
<div class="highlight"><pre><span></span><code><span class="n">ac</span> <span class="o">=</span> <span class="n">Actor_Critic</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">vgrid</span><span class="p">(),</span> <span class="n">α</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">τ</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">γ</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span> <span class="p">,</span> <span class="o">**</span><span class="n">demoQ</span><span class="p">())</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_40_0.png" /></p>
<p>In the below (disabled cell) we can see that the agent arrives at a good policy but it takes long to reach the goal. The reason is because the action-values differences is not high enough to converge to a close to greedy policy. Enable the cell by pressing escape then y and run the cell to see the lengthy run despite an apparent and sound policy shown by the arrows.</p>
<p>ac = Actor_Critic(env=vmaze(), α=.1, γ=.98, episodes=30, seed=0 , **demoQ()).interact()</p>
<p>Below we solve the problem by decaying the exploration rate τ exponentially.</p>
<div class="highlight"><pre><span></span><code><span class="n">ac</span> <span class="o">=</span> <span class="n">Actor_Critic</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">vmaze</span><span class="p">(),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">τmin</span><span class="o">=</span><span class="mf">.05</span><span class="p">,</span> <span class="n">dτ</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span>  <span class="n">γ</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span> <span class="p">,</span> <span class="o">**</span><span class="n">demoQ</span><span class="p">())</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_44_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">ac</span><span class="o">.</span><span class="n">τ</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>0.05
</code></pre></div>
<p>we can also decay linearly τ as follows</p>
<div class="highlight"><pre><span></span><code><span class="n">ac</span> <span class="o">=</span> <span class="n">Actor_Critic</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">vmaze</span><span class="p">(),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">τmin</span><span class="o">=</span><span class="mf">.01</span><span class="p">,</span> <span class="n">Tτ</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>  <span class="n">γ</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span> <span class="p">,</span> <span class="o">**</span><span class="n">demoQ</span><span class="p">())</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_47_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">ac</span><span class="o">.</span><span class="n">τ</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>0.01
</code></pre></div>
<p>However we can achieve a better results by using a combination of intermediate reward and higher learning rate. Let us start by setting a different reward.</p>
<div class="highlight"><pre><span></span><code><span class="n">ac</span> <span class="o">=</span> <span class="n">Actor_Critic</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">vmaze</span><span class="p">(</span><span class="n">reward</span><span class="o">=</span><span class="s1">&#39;reward0&#39;</span><span class="p">),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">τ</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="n">γ</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span> <span class="p">,</span> <span class="o">**</span><span class="n">demoQ</span><span class="p">())</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_50_0.png" /></p>
<p>Now let us increase the learning rate.</p>
<div class="highlight"><pre><span></span><code><span class="n">ac</span> <span class="o">=</span> <span class="n">Actor_Critic</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">vmaze</span><span class="p">(),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span> <span class="n">τ</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="n">γ</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span> <span class="p">,</span> <span class="o">**</span><span class="n">demoQ</span><span class="p">())</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_52_0.png" /></p>
<p>Now let us do both</p>
<div class="highlight"><pre><span></span><code><span class="n">ac</span> <span class="o">=</span> <span class="n">Actor_Critic</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">vmaze</span><span class="p">(</span><span class="n">reward</span><span class="o">=</span><span class="s1">&#39;reward0&#39;</span><span class="p">),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span> <span class="n">τ</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="n">γ</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span> <span class="p">,</span> <span class="o">**</span><span class="n">demoQ</span><span class="p">())</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_54_0.png" /></p>
<p>When we increase exploration for this setting we get </p>
<h1 id="mountain-car-problem">Mountain Car Problem</h1>
<p>We tackle the mountain car problem. This is problem is continuous and attention is needed for the way we represent the states. It has a boundaries for the x position as [-1.2,  .5]. In order to deal with it we need to discretize the X space by dividing it into a number of intervals each has a size of ω.</p>
<h2 id="continuous-problem-and-state-space-discretisation">Continuous Problem and State Space Discretisation</h2>
<p>Below we show how we can discretise the problem by rescaling its range. We show the boundaries as well as some intermediate x positions. Note that we have always nS-2 as the max of the discretized s where the goal location is.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">ind</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">printX</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">X0</span><span class="p">,</span> <span class="n">Xn</span>  <span class="o">=</span> <span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">.5</span> 
    <span class="n">ntiles</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">nS</span> <span class="o">=</span> <span class="n">ntiles</span> <span class="o">+</span><span class="mi">1</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">X0</span><span class="p">,</span> <span class="n">Xn</span><span class="p">,</span> <span class="n">ntiles</span><span class="p">)</span>
    <span class="n">scX</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntiles</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Xn</span> <span class="o">-</span> <span class="n">X0</span><span class="p">)</span> <span class="c1"># scaled range</span>

    <span class="n">s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">scX</span><span class="o">*</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">X0</span><span class="p">))</span> 

    <span class="k">if</span> <span class="n">printX</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;at x=</span><span class="si">%.2f</span><span class="s1"> we have, s=</span><span class="si">%d</span><span class="s1">:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">s</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">()</span>

<span class="n">ind</span><span class="p">(</span><span class="n">x</span><span class="o">=-</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">printX</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># boundary case: far left</span>
<span class="n">ind</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>                 <span class="c1"># boundary case: far right</span>
<span class="n">ind</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">.5</span><span class="o">-</span><span class="mf">.001</span><span class="p">)</span>             <span class="c1"># boundary case: far right</span>
<span class="n">ind</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">.1</span><span class="p">)</span>                 <span class="c1"># mid state</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[-1.2  -1.09 -0.97 -0.86 -0.75 -0.63 -0.52 -0.41 -0.29 -0.18 -0.07  0.05
  0.16  0.27  0.39  0.5 ]
at x=-1.20 we have, s=0:

at x=0.50 we have, s=16:

at x=0.50 we have, s=15:

at x=0.10 we have, s=12:
</code></pre></div>
<p>Note how the index for the far end ==ntiles which means that the number of states is actually ntiles+1.</p>
<h2 id="additive-state-space">Additive State Space</h2>
<p>We have two continuous spaces that specify the position and the velocity state of our car so we need to find a way to combine the two discretised spaces. We start by developing a form of binary encoding that is additive. We will call the set of partitions’ tiles to help the consistency of the cover. But bear in mind that additive spaces are not called tilings.
This will help us gradually move towards tile coding to appreciate its work and why.
Below is the code for animating and dealing with this problem. We have used an additive state space. So, we have concatenated the discrete representation of the position (nS) with the discrete representation for the velocity(ntiles) to make up one vector for representing the position and the velocity of the car where the vector has a size of nS+ntiles.</p>
<p>Ok let us get started...</p>
<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="mf">9.5</span><span class="o">/</span><span class="mf">3.1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="mf">9.5</span><span class="o">//</span><span class="mf">3.1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>3
3.0
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MountainCar</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ntiles</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>  <span class="o">**</span><span class="n">kw</span><span class="p">):</span>   <span class="c1"># ntiles: number of tiles </span>
        <span class="c1"># constants                          </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X0</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">Xn</span>  <span class="o">=</span> <span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">.5</span>       <span class="c1"># position range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xv0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xvn</span> <span class="o">=</span> <span class="o">-</span><span class="mf">.07</span><span class="p">,</span> <span class="mf">.07</span>      <span class="c1"># velocity range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">η</span> <span class="o">=</span> <span class="mi">3</span>                          <span class="c1"># we rescale by 3 to get the wavy valley/hill</span>

        <span class="c1"># for render()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X0</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">Xn</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>     <span class="c1"># car&#39;s position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xv0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xvn</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>    <span class="c1"># car&#39;s speed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">η</span><span class="p">)</span>

        <span class="c1"># for state encoding (indexes)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntiles</span>  <span class="o">=</span> <span class="n">ntiles</span>
        <span class="c1"># number of states is nS*nSd but number of features is nS+nSd with an econdoing power of 2^(nS+nSd)&gt;&gt;nS*nSd!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nS</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntiles</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nA</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="c1"># for compatability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Vstar</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsubplots</span><span class="o">=</span><span class="mi">3</span>

        <span class="c1"># reset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span>  <span class="o">=</span> <span class="o">-</span><span class="mf">.6</span> <span class="o">+</span> <span class="n">rand</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">.4</span><span class="o">+</span><span class="mf">.6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xv</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># figure setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figsize0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># figsize0 is used for compatibility</span>


    <span class="c1"># get the descritized position and velocity</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">s</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tilings</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">floor</span><span class="p">(</span><span class="n">tilings</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ntiles</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span>  <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">X0</span> <span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xn</span>  <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">X0</span> <span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tilings</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">floor</span><span class="p">(</span><span class="n">tilings</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ntiles</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xv</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xv0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Xvn</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xv0</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#self.goals = self.nF -1 # to make sure that it is updated if we update nF</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span>  <span class="o">=</span> <span class="o">-</span><span class="mf">.6</span> <span class="o">+</span> <span class="n">rand</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">.4</span><span class="o">+</span><span class="mf">.6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xv</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_</span><span class="p">()</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">s_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>       
        <span class="n">φ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nF</span><span class="p">)</span> 
        <span class="n">φ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">()]</span> <span class="o">=</span> <span class="mi">1</span> 
        <span class="n">φ</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sv</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntiles</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> 
        <span class="k">return</span> <span class="n">φ</span>

    <span class="c1"># for compatibility</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">S_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nF</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">isatgoal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">Xn</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
        <span class="n">a</span><span class="o">-=</span><span class="mi">1</span>       <span class="c1"># to map from 0,1,2 to -1,0,+1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xv</span> <span class="o">+=</span> <span class="mf">.001</span><span class="o">*</span><span class="n">a</span> <span class="o">-</span> <span class="mf">.0025</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">η</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">xv</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xvn</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xv0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span>  <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xv</span><span class="p">;</span>                              <span class="bp">self</span><span class="o">.</span><span class="n">x</span>  <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>  <span class="bp">self</span><span class="o">.</span><span class="n">Xn</span> <span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">X0</span> <span class="p">)</span>

        <span class="c1"># reset speed to 0 when reaching far left</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">X0</span><span class="p">:</span>  <span class="bp">self</span><span class="o">.</span><span class="n">xv</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">s_</span><span class="p">(),</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">isatgoal</span><span class="p">(),</span> <span class="p">{}</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pause</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">subplot</span><span class="o">=</span><span class="mi">131</span><span class="p">,</span> <span class="n">animate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">visible</span><span class="p">:</span> <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">subplot</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figsize0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">figsize0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">car</span> <span class="o">=</span> <span class="s1">&#39;\ō͡≡o˞̶&#39;</span> <span class="c1"># fastemoji</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fc&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="s1">&#39;pad&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">5</span><span class="p">}</span>

        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span>
        <span class="n">η</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">η</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="o">+</span><span class="mf">.1</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">.1</span><span class="p">,</span><span class="n">Y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">.05</span><span class="p">,</span><span class="s1">&#39;sg&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">Y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">.2</span><span class="p">,</span><span class="s1">&#39;Goal&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Mountain Car&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="c1"># plot the mountain car </span>
        <span class="c1"># take the derivative of the terrain to know the rotation of the car to make it more realistic</span>
        <span class="n">rotation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">η</span><span class="p">))</span><span class="o">*</span><span class="mi">90</span>  
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="o">*</span><span class="n">η</span><span class="p">)</span><span class="o">+</span><span class="mf">.05</span><span class="p">,</span> <span class="n">car</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="n">rotation</span><span class="p">,</span>  <span class="n">size</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">bbox</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">animate</span><span class="p">:</span> <span class="n">clear_output</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">();</span> <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">pause</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">mcar</span> <span class="o">=</span> <span class="n">MountainCar</span><span class="p">()</span>
<span class="n">mcar</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_62_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">mcar</span> <span class="o">=</span> <span class="n">MountainCar</span><span class="p">()</span>
<span class="n">mcar</span><span class="o">.</span><span class="n">x</span>  <span class="o">=</span> <span class="n">mcar</span><span class="o">.</span><span class="n">X0</span>
<span class="n">mcar</span><span class="o">.</span><span class="n">xd</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">while</span> <span class="ow">not</span> <span class="n">mcar</span><span class="o">.</span><span class="n">isatgoal</span><span class="p">():</span>
    <span class="n">mcar</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">mcar</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
    <span class="c1">#print(np.sin(mcar.x))</span>
</code></pre></div>
<p><img alt="png" src="output_63_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">mcar</span><span class="o">.</span><span class="n">xd</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>0
</code></pre></div>
<h2 id="studying-the-behaviour-of-the-car">Studying the behaviour of the car</h2>
<p>Let us see how the car behaves if we do not accelerated forward throttle=0, the car would depend on it mass and the inclination of the terrain and it would keep oscillating backwards and forward.</p>
<div class="highlight"><pre><span></span><code><span class="n">mcar</span><span class="o">.</span><span class="n">x</span>  <span class="o">=</span> <span class="n">mcar</span><span class="o">.</span><span class="n">X0</span>
<span class="n">mcar</span><span class="o">.</span><span class="n">xd</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
    <span class="n">mcar</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mcar</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_66_0.png" /></p>
<p>The above was for starting on top of the left hill, but this is not the starting position of the car. The car always start at the bottom of the valley. Let us see how the car behaves if we just accelerated forward throttle=+1 when we start at the bottom of the valley.</p>
<div class="highlight"><pre><span></span><code><span class="n">mcar</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
    <span class="n">mcar</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">mcar</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_68_0.png" /></p>
<p>Let us see how the car behaves when we start at the top of the right hill and when we just accelerated backwards throttle=-1.</p>
<div class="highlight"><pre><span></span><code><span class="n">mcar</span><span class="o">.</span><span class="n">x</span>  <span class="o">=</span> <span class="n">mcar</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<span class="n">mcar</span><span class="o">.</span><span class="n">xd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
    <span class="n">mcar</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mcar</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_70_0.png" /></p>
<h2 id="optimal-solution">Optimal solution</h2>
<p>Obviously the optimal policy would be to accelerate forward and then backward to gain momentum to be able to reach the top since the car has not enough engine power to reach it by simple forward acceleration.</p>
<div class="highlight"><pre><span></span><code><span class="n">mcar</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

<span class="c1"># swing forward and backward to gain momentum and then go full speed on</span>
<span class="n">swing</span><span class="o">=</span><span class="mi">24</span> <span class="c1"># try 22 or less to see what happen</span>
<span class="c1"># 1. accelerate forward  </span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">swing</span><span class="p">):</span>
    <span class="n">mcar</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">mcar</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

<span class="c1"># 2. accelerate backward to take advantage from the momentum</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">swing</span><span class="p">):</span>
    <span class="n">mcar</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mcar</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

<span class="c1"># 3. now full throttle forward to reach the goal</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
    <span class="n">mcar</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">mcar</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_72_0.png" /></p>
<h2 id="optimal-policy">Optimal Policy</h2>
<p>As we can see, the car must intelligently swing itself forward and then backwards before reaching the top. This kind of problem is hard to find a policy for using traditional control algorithms because things need to get worse (away from the goals) before getting better. The credit assignment plays on the long run rather than on immediate improvements.</p>
<p><strong>Note</strong> that in all what will come below, we set the learning rate to be α=()/8 because the default number of tiles is 8. Please differentiate between this and the number of tilings which we will vary, but it will also be set to 8.</p>
<p>Ok let us start training</p>
<h3 id="short-number-of-episodes">Short number of episodes</h3>
<div class="highlight"><pre><span></span><code><span class="n">sarsa</span> <span class="o">=</span> <span class="n">Sarsa</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">MountainCar</span><span class="p">(),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.5</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="n">ε</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">demoQ</span><span class="p">())</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_75_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">qlearn</span> <span class="o">=</span> <span class="n">Qlearn</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">MountainCar</span><span class="p">(),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.5</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="n">ε</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">demoQ</span><span class="p">())</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_76_0.png" /></p>
<p>Longer episodes</p>
<div class="highlight"><pre><span></span><code><span class="n">sarsa</span> <span class="o">=</span> <span class="n">Sarsa</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">MountainCar</span><span class="p">(),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.5</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>  <span class="n">ε</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">demoQ</span><span class="p">())</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_78_0.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">qlearn</span> <span class="o">=</span> <span class="n">Qlearn</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">MountainCar</span><span class="p">(),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.5</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="n">ε</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">demoQ</span><span class="p">())</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_79_0.png" /></p>
<p>Note that there is uncontrollable element of randomness due to the random starting position of the car that is part of the hardness of the problem. So each time you run even with the same seed you will get a different learning curve.</p>
<h3 id="exploration-by-optimistic-initialisation">Exploration by optimistic initialisation</h3>
<p>We use a reward scheme of -1 in every step with an initial value function of 0. These initial values are optimistic, given that the agent will be punished for every step before reaching the goal. Such settings naturally encourage the agent to explore the early episodes because it will be disappointed by the reward that it gets, so we do not need to adopt an exploratory policy explicitly, and we can set ε=0. Let us see how the Sarsa act on such a purely greedy policy with optimistic initialisation to encourage exploration.</p>
<div class="highlight"><pre><span></span><code><span class="n">sarsa</span> <span class="o">=</span> <span class="n">Sarsa</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">MountainCar</span><span class="p">(),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.1</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span>   <span class="n">ε</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="n">episodes</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">demoQ</span><span class="p">())</span><span class="o">.</span><span class="n">interact</span><span class="p">()</span>
</code></pre></div>
<p><img alt="png" src="output_82_0.png" /></p>
<h2 id="sarsa-for-binary-encoding">Sarsa for Binary Encoding</h2>
<p>Let us make our Sarsa implementation more efficient for a binary encoding where each component in the state vector is either 0 or 1. This simplifies the implementation of the dot product to be turned into summation. below we show the implementation.</p>
<div class="highlight"><pre><span></span><code><span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="c1"># s = np.array([0, 0 , 0, 0, 0])</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">.1</span><span class="p">,</span><span class="mf">.2</span> <span class="p">,</span><span class="mf">.3</span><span class="p">,</span> <span class="mf">.4</span><span class="p">,</span> <span class="mf">.5</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span> <span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]])</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">s</span><span class="o">!=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">S</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">W</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">s</span><span class="o">!=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">W</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">s</span><span class="o">!=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">W</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">s</span><span class="o">!=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>2
1
3
0.6
6.0
[0.6 6. ]
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SarsaB</span><span class="p">(</span><span class="n">vMDP</span><span class="p">):</span>  <span class="c1"># Binary Sarsa that deals with binary state representation (later will have multiple tilings so we would have more than one hot encoding but each tilings is a one-hot encoding)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">init</span><span class="p">()</span> <span class="c1"># α=.8</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="kc">False</span>       
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_an</span> <span class="c1"># for Sarsa we want to decide the next action in time step t</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Q_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> 
        <span class="n">s_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">s</span><span class="o">!=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># set of indexes that represents states because we use a binary representation</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[:,</span><span class="n">s_</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">s_</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Q</span> <span class="k">if</span> <span class="n">Q</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="c1"># ----------------------------------------🌖 online learning ----------------------------------------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">online</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">rn</span><span class="p">,</span><span class="n">sn</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span><span class="n">an</span><span class="p">):</span>
        <span class="n">s_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">s</span><span class="o">!=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">s_</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">α</span><span class="o">*</span><span class="p">(</span><span class="n">rn</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">done</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">γ</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span><span class="n">an</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">a</span><span class="p">))</span>
</code></pre></div>
<h2 id="runs-on-mountain-car">Runs on Mountain Car</h2>
<p>Let us now see the Sarsa behaviour on several runs</p>
<div class="highlight"><pre><span></span><code><span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
<span class="o">%</span><span class="n">time</span> <span class="n">sarsaRuns</span> <span class="o">=</span> <span class="n">Runs</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">Sarsa</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">MountainCar</span><span class="p">(),</span><span class="n">α</span><span class="o">=</span><span class="mf">.1</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">ε</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>\
                       <span class="n">runs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">plotT</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sarsa on Mountain Car&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|10/10
CPU times: user 32.7 s, sys: 77.5 ms, total: 32.8 s
Wall time: 32.8 s
</code></pre></div>
<p><img alt="png" src="output_87_1.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
<span class="o">%</span><span class="n">time</span> <span class="n">sarsaRuns</span> <span class="o">=</span> <span class="n">Runs</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">SarsaB</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">MountainCar</span><span class="p">(),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.1</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">ε</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>\
                       <span class="n">runs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">plotT</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sarsa on Mountain Car&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|10/10
CPU times: user 1min 8s, sys: 843 ms, total: 1min 9s
Wall time: 1min 9s
</code></pre></div>
<p><img alt="png" src="output_88_1.png" /></p>
<p>As we can see both runs plots are identical as expected. However, Sarsa is faster than the Binary Sarsa. The reason is as usual the dot product is highly optimised and unless we are dealing with a very large state space the usual Sarsa is more efficient.</p>
<h2 id="binary-mountain-car-class-and-binary-sarsa">Binary Mountain Car Class and Binary Sarsa</h2>
<p>If we guarantee that we send indices instead of a feature vector we might be able to reduce the overhead. Let us see how.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SarsaB</span><span class="p">(</span><span class="n">vMDP</span><span class="p">):</span>  <span class="c1"># Binary Sarsa that deals with binary state representation (later will have multiple tilings so we would have more than one hot encoding but each tilings is a one-hot encoding)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">init</span><span class="p">()</span> <span class="c1"># α=.8</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_an</span> <span class="c1"># for Sarsa we want to decide the next action in time step t</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">Q_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">T</span> 
        <span class="n">Q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[:,</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Q</span> <span class="k">if</span> <span class="n">Q</span><span class="o">.</span><span class="n">size</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="c1"># ----------------------------------------🌖 online learning ----------------------------------------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">online</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">rn</span><span class="p">,</span><span class="n">sn</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span><span class="n">an</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">α</span><span class="o">*</span><span class="p">(</span><span class="n">rn</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">done</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">γ</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span><span class="n">an</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">a</span><span class="p">))</span>
</code></pre></div>
<p>As we can see we got rid of the s_ = np.where(s!=0)[0] statement in both the Q_() and online() functions. This statements obtain the indexes of the features that are on. To guarantee that s contain the indexes we need to adjust the environment as follows.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MountainCarB</span><span class="p">(</span><span class="n">MountainCar</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">s_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">sv</span><span class="p">()</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntiles</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</code></pre></div>
<p>Now let us run the same experiments on the new two classes MountainCarB and SarsaB.</p>
<div class="highlight"><pre><span></span><code><span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
<span class="o">%</span><span class="n">time</span> <span class="n">sarsaRuns</span> <span class="o">=</span> <span class="n">Runs</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">SarsaB</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">MountainCarB</span><span class="p">(),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.1</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">ε</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>\
                       <span class="n">runs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">plotT</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sarsa on Mountain Car&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|10/10
CPU times: user 1min, sys: 550 ms, total: 1min 1s
Wall time: 1min 1s
</code></pre></div>
<p><img alt="png" src="output_95_1.png" /></p>
<h2 id="mountain-car-runs">Mountain Car Runs</h2>
<p>Let us now develop a function to conduct several runs on the mountain car problem to see how the different state representations perform with different learning rates.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">MountainCarRuns</span><span class="p">(</span><span class="n">runs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">algo</span><span class="o">=</span><span class="n">Sarsa</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">MountainCar</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ε</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">α</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">.1</span><span class="p">,</span> <span class="mf">.2</span><span class="p">,</span> <span class="mf">.5</span><span class="p">]:</span>
        <span class="n">sarsaRuns</span> <span class="o">=</span> <span class="n">Runs</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">algo</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">α</span><span class="o">=</span><span class="n">α</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">ε</span><span class="o">=</span><span class="n">ε</span><span class="p">),</span>
                         <span class="n">runs</span><span class="o">=</span><span class="n">runs</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">plotT</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;α=</span><span class="si">%.2f</span><span class="s1">/8&#39;</span><span class="o">%</span><span class="n">α</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="mi">10</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Semi Gradient &#39;</span> <span class="o">+</span> <span class="n">algo</span><span class="o">.</span><span class="vm">__name__</span>  <span class="o">+</span><span class="s1">&#39; on Mountain Car &#39;</span><span class="o">+</span><span class="n">label</span><span class="p">)</span>

<span class="n">fig_10_2</span> <span class="o">=</span> <span class="n">MountainCarRuns</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">%</span><span class="n">time</span> <span class="n">MountainCarRuns</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
CPU times: user 2min 49s, sys: 470 ms, total: 2min 49s
Wall time: 2min 50s
</code></pre></div>
<p><img alt="png" src="output_98_1.png" /></p>
<p>As we can see, the algorithm shows some signs of underperformance and instability. This is a common problem when we have less representational capabilities in our state space due to the additivity nature of our space.</p>
<p>The adopted additive representation is ok, but it has its limitations. The main issue is that the total number of possible states is <span class="arithmatex">\(ntiles \times ntiles\)</span>, but the dimensionality of our vector is far less than that it is ntiles+ntiles. It is not a one-hot encoding, so each component does not correspond to one state. Instead, two components correspond to one state. These two issues combined reduced the capability of our algorithms to generalise to nearby states.</p>
<h2 id="multiplicative-state-space-tile-coding-for-mountain-car">Multiplicative State Space: Tile Coding for Mountain Car</h2>
<p>In this section, we alter the state representation to have multiplicative space with a vector of size <span class="arithmatex">\(ntiles \times ntiles\)</span> to have a state dimensionality that matches the discrete space dimensionality. In effect, we return to one-hot encoding with each component corresponding with one state (of position and velocity). </p>
<p>Hence, we will cover the space with a grid of 2-d instead of the two 1-d arrays of position and velocity we concatenated earlier. This will make the space dimension <span class="arithmatex">\(ntiles \times ntiles\)</span>. The benefit is that we would have one hot encoding instead of the 2-hot encoding. Usually, in RL, one-hot encoding outperforms other encoding and is tried and tested in many applications. </p>
<p>When we use multiple tilings, the space is <span class="arithmatex">\(ntiles \times ntiles \times ntilings\)</span> where ntilings is the number of tilings. When we move to multiple tilings, we may have abandoned the one-hot encoding. However, we have made the state vector's total representation <em>power</em> multiple times what the discretised space is. This redundancy is crucial and works best for RL. </p>
<p>This is similar to the idea of increasing the dimensionality in kernel methods which allowed us to gain more power in state representation, and then we found computationally convenient ways of reducing the computing demands via the kernel trick. Here, we also increase the space dimensionality via adopting multiple tilings, but then we reduce its computing demands by the hashing trick. So, we hash the bigger multiplicative state space into a fixed table which improves the efficiency of our algorithms and guarantees bounded memory and time complexities.</p>
<p>Below we show how to change the representation of our space to a 2-d which greatly increases its dimensionality due to multiplication. But first, we start off by showing the effect of the rescaling, and then we show the implementation.</p>
<div class="highlight"><pre><span></span><code><span class="n">ntilings</span> <span class="o">=</span> <span class="n">ntiles</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">X0</span><span class="p">,</span> <span class="n">Xn</span>  <span class="o">=</span> <span class="o">-</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">.5</span>
<span class="n">scaling</span> <span class="o">=</span> <span class="p">(</span><span class="n">ntilings</span><span class="o">*</span><span class="n">ntiles</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Xn</span><span class="o">-</span><span class="n">X0</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">X0</span>                <span class="c1"># left boundary state</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">X0</span> <span class="o">+</span> <span class="p">(</span><span class="n">Xn</span><span class="o">-</span> <span class="n">X0</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>   <span class="c1"># mid state</span>
<span class="c1"># x = Xn                # right boundary state</span>

<span class="n">tiling</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># any value between 0..ntilings-1</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">X0</span><span class="p">)</span><span class="o">*</span><span class="n">scaling</span> <span class="o">+</span> <span class="n">tiling</span> <span class="p">)</span><span class="o">//</span><span class="n">ntilings</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>2
</code></pre></div>
<p>Let us see also how the tilings and tiles indexes works together.</p>
<div class="highlight"><pre><span></span><code><span class="n">inds</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># ntilings = ntiles = 3</span>
<span class="n">ds_s</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># displacement for s</span>
<span class="n">ds_sv</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># displacement for sv</span>
<span class="k">for</span> <span class="n">tiling</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntilings</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span>  <span class="nb">int</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">X0</span><span class="p">)</span><span class="o">*</span><span class="n">scaling</span> <span class="o">+</span> <span class="n">ds_s</span><span class="o">*</span><span class="n">tiling</span> <span class="p">)</span><span class="o">//</span><span class="n">ntilings</span>
    <span class="n">sv</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">X0</span><span class="p">)</span><span class="o">*</span><span class="n">scaling</span> <span class="o">+</span> <span class="n">ds_sv</span><span class="o">*</span><span class="n">tiling</span> <span class="p">)</span><span class="o">//</span><span class="n">ntilings</span>
    <span class="n">inds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tiling</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">sv</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">inds</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[(0, 2, 2), (1, 2, 3), (2, 2, 3), (3, 3, 4), (4, 3, 4)]
</code></pre></div>
<p>ok let us construct a feature vector and turn it corresponding indices</p>
<div class="highlight"><pre><span></span><code><span class="n">φ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntilings</span><span class="p">,</span> <span class="n">ntiles</span><span class="o">+</span><span class="n">ds_s</span><span class="p">,</span> <span class="n">ntiles</span><span class="o">+</span><span class="n">ds_s</span><span class="o">+</span><span class="n">ds_sv</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">inds</span><span class="p">:</span> 
    <span class="n">φ</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>

<span class="c1"># we will print one tiling but feel free to print them all</span>
<span class="n">tiling</span><span class="o">=</span><span class="mi">2</span> <span class="c1"># any value between 0..ntilings-1</span>
<span class="nb">print</span><span class="p">(</span><span class="n">φ</span><span class="p">[</span><span class="n">tiling</span><span class="p">])</span>
<span class="c1"># print(φ)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>[[0. 0. 0. 0. 0. 0. 0. 0. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 0.]
 [0. 0. 0. 1. 0. 0. 0. 0. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 0.]
 [0. 0. 0. 0. 0. 0. 0. 0. 0.]]
</code></pre></div>
<p>As we can see the corresponding indices have been turned on. </p>
<p>We can now flatten the feature vector φ.</p>
<div class="highlight"><pre><span></span><code><span class="n">φ</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>array([0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
       0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
       0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
       0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
       0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
       0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
       0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
       0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0.,
       0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
       0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
       0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
       0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
       0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
       0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
       0., 0., 0., 0., 0., 0., 0., 0., 0., 1., 0., 0., 0., 0., 0., 0., 0.,
       0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.])
</code></pre></div>
<p>Note how we have exactly ntilings features turned on and the rest are 0. </p>
<p>Ok so now we are ready to develop our tiled Mountain Car class.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">tiledMountainCar</span><span class="p">(</span><span class="n">MountainCar</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ntilings</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span> <span class="c1"># ntilings: is number of tiles</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntilings</span> <span class="o">=</span> <span class="n">ntilings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntilings</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntiles</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntiles</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># the redundancy to mach the displacements of position(x) and velocity(xv)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">inds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s_tiling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntilings</span><span class="p">)</span>
        <span class="n">sv_tiling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntilings</span><span class="p">)</span>

        <span class="n">inds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tiling</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntilings</span><span class="p">):</span>
            <span class="n">s</span>  <span class="o">=</span> <span class="p">(</span><span class="n">s_tiling</span>  <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="n">tiling</span> <span class="p">)</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">ntilings</span>
            <span class="n">sv</span> <span class="o">=</span> <span class="p">(</span><span class="n">sv_tiling</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">tiling</span> <span class="p">)</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">ntilings</span>
            <span class="n">inds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tiling</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">sv</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">inds</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">s_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">φ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inds</span><span class="p">():</span> <span class="n">φ</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">φ</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</code></pre></div>
<p>As we can see, the implementation is simple we rescale x and xv, add the current tiling and divide the result by the number of tilings. In effect, this creates multiple space partitions, each shifted by (1*ω/n)*i for the car position x by (3*ωv/n)*i for the car velocity xv. </p>
<p>We have rescaled the entire position, and velocity ranges into ntiles <span class="arithmatex">\(\times\)</span> ntilings. You can think of the number of tiles as centimetres and the nilings as millimeters on a ruler. The ruler may be 16 tiles (centimetres) long. Each tile is divided into 10 tilings(millimetres), but we have 10 rulers (the number of tilings is the same as the number of pieces each tile is divided into). Then when we want to know the encoding, we measure on the ruler where the input x is to obtain its tile. The first ruler starts at the start of the x range. Then we pick another ruler and offset its starting position by 1 millimetre (1 tiling), and we check the measure of our x on the second ruler to obtain its tile on the second ruler (on the second tiling), and we repeat the same process for all 10 rulers. </p>
<p>We get a set of 10 active tiles on the 10 rulers, these will be our indexes that will be turned on in our state vector, and the rest are 0s. Our state vector size is ntiles x ntiles x n. The 1 and 3 are displacements to make the offset asymmetrical, which helps the generalisation (see figure 9.11 in the book for more details).</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">SarsaOnMountainCar</span><span class="p">(</span><span class="n">ntilings</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">tiledMountainCar</span><span class="p">):</span>
    <span class="n">sarsa</span> <span class="o">=</span> <span class="n">Sarsa</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">(</span><span class="n">ntilings</span><span class="o">=</span><span class="n">ntilings</span><span class="p">),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.5</span><span class="o">/</span><span class="n">ntilings</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ε</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">plotT</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;ntilings=</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">ntilings</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">SarsaOnMountainCar</span><span class="p">(</span><span class="n">ntilings</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|████████████████████████████████████████████████████████████████████████████████████████████████| 5/5 [00:15&lt;00:00,  3.00s/it]
</code></pre></div>
<p><img alt="png" src="output_112_1.png" /></p>
<p>Note the difference between the max steps and the max steps when we did not use tile coding. We will demonstrate the  advantage of tile coding further in a more extensive experiments.</p>
<h3 id="tiled-coded-mountain-car-runs">Tiled coded mountain car runs</h3>
<p>Let us see how the new tile coding behaves with respect to different learning rates, to do we simply call the SarsaMCar() function but we pass the tiledMountainCar environment with n=8.</p>
<div class="highlight"><pre><span></span><code><span class="n">MountainCarRuns</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">tiledMountainCar</span><span class="p">(</span><span class="n">ntilings</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="n">ε</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;with 8 tilings&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
</code></pre></div>
<p><img alt="png" src="output_115_1.png" /></p>
<p>Note that since we set  ε=0 and used optimistically initialisation, these settings made Sarsa closer to Q-learning in the sense that it is learning about a purely greedy policy (of course Q-learning is acting usually according to an exploratory policy  ε-greedy). Let us see how Q-learning behaves if we also set ε=0.</p>
<div class="highlight"><pre><span></span><code><span class="n">MountainCarRuns</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">tiledMountainCar</span><span class="p">(</span><span class="n">ntilings</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="n">ε</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;with 8 tilings&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
</code></pre></div>
<p><img alt="png" src="output_117_1.png" /></p>
<div class="highlight"><pre><span></span><code><span class="n">MountainCarRuns</span><span class="p">(</span><span class="n">algo</span><span class="o">=</span><span class="n">Qlearn</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">tiledMountainCar</span><span class="p">(</span><span class="n">ntilings</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;with 8 tilings&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
</code></pre></div>
<p><img alt="png" src="output_118_1.png" /></p>
<p>Indeed as we can see .&#8541; seems to be performing best for a additive one tile coding (the above class implemented one-hot coding which is a special case of tile coding where n=1). In the next section we implement a more generic state representation that allows for multiple tilings.</p>
<h2 id="binary-tiled-mountain-car">Binary Tiled Mountain Car</h2>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">tiledMountainCarB</span><span class="p">(</span><span class="n">tiledMountainCar</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span> <span class="c1">#ntilings: is number of tiles</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">s_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">inds</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">s_tiling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntilings</span><span class="p">)</span>
        <span class="n">sv_tiling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntilings</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">tiling</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntilings</span><span class="p">):</span>
            <span class="n">s</span>  <span class="o">=</span> <span class="p">(</span><span class="n">s_tiling</span>  <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="n">tiling</span> <span class="p">)</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">ntilings</span>
            <span class="n">sv</span> <span class="o">=</span> <span class="p">(</span><span class="n">sv_tiling</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">tiling</span> <span class="p">)</span><span class="o">//</span><span class="bp">self</span><span class="o">.</span><span class="n">ntilings</span>
            <span class="n">ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">tiling</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">sv</span>
            <span class="n">inds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">inds</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">MountainCarRuns</span><span class="p">(</span><span class="n">algo</span><span class="o">=</span><span class="n">SarsaB</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">tiledMountainCarB</span><span class="p">(</span><span class="n">ntilings</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Binary Mountain Car with 8 tilings&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
</code></pre></div>
<p><img alt="png" src="output_122_1.png" /></p>
<p>As we can see again the performance is the same with an extra cost overhead in terms of time.</p>
<h2 id="multiplicative-state-space-hashed-tile-coding-for-mountain-car">Multiplicative State Space: <em>Hashed</em> Tile Coding for Mountain Car</h2>
<p>This section draws on the idea of hashing a tile coding representation to reduce its dimensionality to make it more efficient. To solve the issues of high dimensionality when using multiple tilings, we can resort to the idea of <em>hashing</em>, which will help us to maintain a high resolution but reduce the space dimensionality. It does that by fixing the state space dimensionality regardless of the discretised space. </p>
<p>It takes advantage of the fact that not all states will be visited as often, and when the agent starts exploring, the earlier states will be guaranteed to have unique encoding. Only later on, for less frequent states when the hashing table runs out of spaces, will there be some colliding (i.e. two states would have the same encoding). This violates a uniqueness of representation which is an explicit condition for several algorithms or similarity of representation for close states. However, such an effect is minimal compared to the benefits of redundancy of the original discretised space. The disadvantage can be ignored given that we made our table large enough.</p>
<p>Below we show a basic implementation of hashing. The idea is very simple; we hash the index of the feature that we were turning on in the tiledMountainCar class. In other words, we take the two indexes of position and velocity, along with the tiling index, and we hash the three indexes as a tuple. Then we apply the modulus % with the hash_size (same as the number of features) to obtain the index of the feature that we want it to be active. Note that the hashing function gives us some number that represents the tuple. We will get the same number each time we pass the same tuple. That is all that is being provided by the built-in hashing function. However, some different tuples might have the same modulus, which will cause collision even when the table size is larger than the state space. We will try to avoid this collision issue later. At least, we will minimise it so that it occurs only when the state space exceeds the table size.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">hashedtiledMountainCar</span><span class="p">(</span><span class="n">tiledMountainCar</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hash_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span> 
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nF</span> <span class="o">=</span> <span class="n">hash_size</span> <span class="c1"># fixed size that does not vary with the ntilings* ntiles</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">s_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">φ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nF</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inds</span><span class="p">():</span>
            <span class="n">φ</span><span class="p">[</span><span class="nb">hash</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">nF</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">φ</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">%</span><span class="n">time</span> <span class="n">sarsa</span> <span class="o">=</span> <span class="n">Sarsa</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">hashedtiledMountainCar</span><span class="p">(</span><span class="n">ntilings</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ntiles</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.3</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ε</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">plotT</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;hased tiled&#39;</span><span class="p">)</span>
<span class="o">%</span><span class="n">time</span> <span class="n">sarsa</span> <span class="o">=</span> <span class="n">Sarsa</span><span class="p">(</span><span class="n">env</span><span class="o">=</span>      <span class="n">tiledMountainCar</span><span class="p">(</span><span class="n">ntilings</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ntiles</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="n">α</span><span class="o">=</span><span class="mf">.3</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ε</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">plotT</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;tiled&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>CPU times: user 3.03 s, sys: 8.76 ms, total: 3.04 s
Wall time: 3.05 s





(100.0, 1000.0)
</code></pre></div>
<p><img alt="png" src="output_126_2.png" /></p>
<p>Note that there are some differences in the results of the last two steps graphs due to the issue of collisions that was discussed above.</p>
<div class="highlight"><pre><span></span><code><span class="o">%</span><span class="n">time</span> <span class="n">MountainCarRuns</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">hashedtiledMountainCar</span><span class="p">(</span><span class="n">ntilings</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ntiles</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">hash_size</span><span class="o">=</span><span class="mi">8</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="mi">8</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;with hashed 8*8*8 tiles&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
CPU times: user 3min 26s, sys: 518 ms, total: 3min 26s
Wall time: 3min 27s
</code></pre></div>
<p><img alt="png" src="output_128_1.png" /></p>
<p>Let us reduce the hash table size (i.e. the number of features) used to represent <em>a state</em>. Once we have less representation power we expect deterioration in performance. Note that we still are dealing with 8x8x8 tiled coding we are reducing the capability of the hash table to accommodate all of the discretised states with no collision.</p>
<div class="highlight"><pre><span></span><code><span class="o">%</span><span class="n">time</span> <span class="n">MountainCarRuns</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">hashedtiledMountainCar</span><span class="p">(</span><span class="n">ntilings</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ntiles</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">hash_size</span><span class="o">=</span><span class="mi">8</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="mi">4</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;with hashed 8*8*8 tiles&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
CPU times: user 4min 4s, sys: 821 ms, total: 4min 5s
Wall time: 4min 6s
</code></pre></div>
<p><img alt="png" src="output_130_1.png" /></p>
<p>As we can see the performance of the model deteriorated a bit when we reduced the hash table size due to collision.</p>
<h2 id="index-hashed-table-iht">Index Hashed Table (IHT)</h2>
<p>Directly using the hash function on upcoming tuples of indexes is fine, but it loses an opportunity to store nearby states in nearby locations and to guarantee consistency in allowing for collision. A collision occurs when two tuples have the same index values. This means that two states will have the same representation, and the uniqueness of representation is violated. This can be a last resort for a very large state space, but it is better not to for small to medium spaces. </p>
<p>The index hash table allows us to store the tuples as values (in a dictionary) and their indices as keys. Thanks to the dictionary structure in Python, we can retrieve the index of a tuple at any point with O(1) cost to do. What is left is then to only resort to hashing a key when we cannot store it anymore in the table, and in this case, we need to live with collision. Below we show a simplified and more concise implementation. For more details, refer to <a href="http://incompleteideas.net/tiles/tiles3.py-remove">hash tile coding</a>, described in our textbook. We built our code differently to avoid storing the indices explicitly in a table for more efficiency. The standard software has extra capabilities we do not need here (ex. adding the action index is unnecessary since we do not amalgamate all the weights of different actions in one large weight vector).</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">IHTtiledMountainCar</span><span class="p">(</span><span class="n">tiledMountainCar</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iht_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span> <span class="c1"># by default we have 8*8*8 (position tiles * velocity tiles * tilings)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nF</span> <span class="o">=</span> <span class="n">iht_size</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">s_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">φ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nF</span><span class="p">)</span>
        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">s_</span><span class="p">()</span><span class="o">!=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">φ</span><span class="p">[</span><span class="n">inds</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">nF</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">φ</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="mi">10</span><span class="o">*</span><span class="mi">11</span><span class="o">*</span><span class="mi">8</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>880
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">%</span><span class="n">time</span> <span class="n">sarsa</span> <span class="o">=</span> <span class="n">Sarsa</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">IHTtiledMountainCar</span><span class="p">(</span><span class="n">ntilings</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ntiles</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> \
                <span class="n">α</span><span class="o">=</span><span class="mf">.3</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ε</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">plotT</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;IHT tilings&#39;</span><span class="p">)</span>

<span class="o">%</span><span class="n">time</span> <span class="n">sarsa</span> <span class="o">=</span> <span class="n">Sarsa</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">tiledMountainCar</span><span class="p">(</span><span class="n">ntilings</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ntiles</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> \
                <span class="n">α</span><span class="o">=</span><span class="mf">.3</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ε</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">plotT</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;tilings&#39;</span><span class="p">)</span>

<span class="c1"># %time sarsa = Sarsa(env=hashedtiledMountainCar(ntilings=8, ntiles=8), α=.3/8, episodes=500, seed=1, ε=0, plotT=True).interact(label=&#39;hashed tilings&#39;)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>CPU times: user 2.93 s, sys: 3.14 ms, total: 2.93 s
Wall time: 2.93 s





(100.0, 1000.0)
</code></pre></div>
<p><img alt="png" src="output_135_2.png" /></p>
<p>Note how the two graphs are identical, although we have used an index hashing table (IHT) in the second while we did not in the first. This is because IHT maps the indices of the visited states, and unless the number of states exceeds the IHT size, the results will be identical to those with no hashing. This is the major advantage of IHT over just hashing. The downside is that it can be computationally more expensive to use IHT, so the equivalence is with an overhead cost. However, in our implementation, we have avoided this overhead completely!</p>
<div class="highlight"><pre><span></span><code><span class="n">MountainCarRuns</span><span class="p">(</span><span class="n">runs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">IHTtiledMountainCar</span><span class="p">(</span><span class="n">ntilings</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">ntiles</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;with index hashed table for 8*8*8 tiles&#39;</span><span class="p">)</span>
<span class="n">MountainCarRuns</span><span class="p">(</span><span class="n">runs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span>   <span class="n">tiledMountainCar</span><span class="p">(</span><span class="n">ntilings</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">ntiles</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;with 8*8*8 tiles&#39;</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|10/10
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|10/10
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|10/10
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|10/10
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|10/10
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|10/10
</code></pre></div>
<p><img alt="png" src="output_137_1.png" /></p>
<h3 id="collisions-in-a-hash-representation">Collisions in a Hash Representation</h3>
<p>Note that the actual state dimension is tiles <em><span class="arithmatex">\(\times\)</span> tiles  <span class="arithmatex">\(\times\)</span> number of tilings</em>: since we have the 8 tiles for the positions and 8 for the velocity (8 by 8 grid) and 8 tilings:</p>
<div class="highlight"><pre><span></span><code><span class="mi">8</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="mi">8</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>512
</code></pre></div>
<p>So we could get away with 512 without collision in the hash table. Collision occurs whenever we use the same key for more than one state. We scarify some accuracy due this collision. So unless it is necessary we try to avoid it by being generous in the memory allocation for the hash table (same as our feature vector). We may allow  some collision for larger space on the base that important states will be visited more often and hence their representation will overshadow other less frequent states.</p>
<h2 id="tilings-comparison">Tilings Comparison</h2>
<p>In this section we compare between the performance of Sarsa on different tilings to see the effect of changing the power of state representation.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">MountainCarTilings</span><span class="p">(</span><span class="n">runs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">α</span><span class="o">=</span><span class="mf">.3</span><span class="p">,</span> <span class="n">algo</span><span class="o">=</span><span class="n">Sarsa</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">tiledMountainCar</span><span class="p">):</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Sarsa on mountain car: comparison of different tilings with α=</span><span class="si">%.2f</span><span class="s1">/8&#39;</span><span class="o">%</span><span class="n">α</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ntilings</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">]:</span>
        <span class="n">sarsaRuns</span> <span class="o">=</span> <span class="n">Runs</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">algo</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">(</span><span class="n">ntiles</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ntilings</span><span class="o">=</span><span class="n">ntilings</span><span class="p">),</span><span class="n">α</span><span class="o">=</span><span class="n">α</span><span class="o">/</span><span class="n">ntilings</span><span class="p">,</span><span class="n">episodes</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">ε</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> 
                         <span class="n">runs</span><span class="o">=</span><span class="n">runs</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">plotT</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> tilings&#39;</span><span class="o">%</span><span class="n">ntilings</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="mi">10</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">MountainCarTilings</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
</code></pre></div>
<p><img alt="png" src="output_143_1.png" /></p>
<h2 id="comparing-n-step-sarsa-on-mountain-car-with-different">Comparing n-Step Sarsa on Mountain Car with different  α</h2>
<p>Let us compare systematically how different number of steps plays with the learning rate α for the mountain car problem. We will use hashed tilings with 8 tiles and 8 tilings. The goal is to confirm whether the behaviour of n-step Sarsa for control is compatible with the behaviour of n-step TD for prediction. </p>
<p>Below we show the implementation of n-step Sarsa with function approximation. It is identical to the tabular form except we use the function Q(sn,an) instead of Q[sn,an].</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Sarsan</span><span class="p">(</span><span class="n">vMDP</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="kc">True</span>        <span class="c1"># although online but we need to access *some* of earlier steps,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_an</span> <span class="c1"># for Sarsa we want to decide the next action in time step t</span>

    <span class="c1"># ----------------------------- 🌖 online learning ----------------------    </span>
    <span class="k">def</span><span class="w"> </span><span class="nf">online</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">τ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>  <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span>
        <span class="k">if</span> <span class="n">τ</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span> <span class="k">return</span>

        <span class="c1"># we take the min so that we do not exceed the episode limit (last step+1)</span>
        <span class="n">τ1</span> <span class="o">=</span> <span class="n">τ</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">τn</span> <span class="o">=</span> <span class="n">τ</span><span class="o">+</span><span class="n">n</span> <span class="p">;</span> <span class="n">τn</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">τn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">skipstep</span><span class="p">)</span>

        <span class="n">sτ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="n">τ</span><span class="p">];</span>  <span class="n">aτ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">τ</span><span class="p">]</span>
        <span class="n">sn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="n">τn</span><span class="p">];</span> <span class="n">an</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">τn</span><span class="p">]</span>
        <span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">[</span><span class="n">τn</span><span class="p">]</span>

        <span class="c1"># n steps τ+1,..., τ+n inclusive of both ends</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">W</span><span class="p">[</span><span class="n">aτ</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">α</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">(</span><span class="n">τ1</span><span class="p">,</span><span class="n">τn</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">done</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">γ</span><span class="o">**</span><span class="n">n</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span><span class="n">an</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">(</span><span class="n">sτ</span><span class="p">,</span><span class="n">aτ</span><span class="p">))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ΔQ</span><span class="p">(</span><span class="n">sτ</span><span class="p">)</span>
</code></pre></div>
<p>Below we see that the an intermediate n (number of steps in n-step Sarsa) acts best in similar to the effect of the number of steps on random walk and that control algorithms with intermediate bootstrapping usually performs best.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">MountainCarTiledRuns_n</span><span class="p">(</span><span class="n">runs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">algo</span><span class="o">=</span><span class="n">Sarsan</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">tiledMountainCar</span><span class="p">):</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">algo</span><span class="o">.</span><span class="vm">__name__</span><span class="o">+</span><span class="s1">&#39; on mountain car: comparison of n-steps with the same 8x8x8 tilings&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">α</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="p">[</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">.3</span><span class="p">]):</span>
        <span class="n">sarsaRuns</span> <span class="o">=</span> <span class="n">Runs</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">algo</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">(</span><span class="n">ntiles</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ntilings</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">α</span><span class="o">=</span><span class="n">α</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span><span class="n">episodes</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">ε</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> 
                         <span class="n">runs</span><span class="o">=</span><span class="n">runs</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">plotT</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">interact</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> step-Sarsa, α=</span><span class="si">%.2f</span><span class="s1">/8&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">α</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="mi">10</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">figure_10_3_n</span> <span class="o">=</span> <span class="n">MountainCarTiledRuns_n</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">%</span><span class="n">time</span> <span class="n">figure_10_3_n</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">tiledMountainCar</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
</code></pre></div>
<p><img alt="png" src="output_148_1.png" /></p>
<div class="highlight"><pre><span></span><code>CPU times: user 2min 1s, sys: 231 ms, total: 2min 1s
Wall time: 2min 1s
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">%</span><span class="n">time</span> <span class="n">figure_10_3_n</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">hashedtiledMountainCar</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
</code></pre></div>
<p><img alt="png" src="output_149_1.png" /></p>
<div class="highlight"><pre><span></span><code>CPU times: user 2min 10s, sys: 249 ms, total: 2min 11s
Wall time: 2min 11s
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="o">%</span><span class="n">time</span> <span class="n">figure_10_3_n</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">IHTtiledMountainCar</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
100%|[90m██████████████████████████████████████████████████████████████████████████████████████████[0m|20/20
</code></pre></div>
<p><img alt="png" src="output_150_1.png" /></p>
<div class="highlight"><pre><span></span><code>CPU times: user 2min 28s, sys: 270 ms, total: 2min 28s
Wall time: 2min 28s
</code></pre></div>
<p>As we can see the IHT performed exactly the same as the tiledMountainCar representation since we are using a large enough table_size, it gave a boost to the one-step Sarsa to become closer to the 8-step Sarsa.</p>
<h3 id="model-selection-for-n_step-sarsa">Model Selection for n_step Sarsa</h3>
<p>In this section we conduct an extensive set of experiments on Mountain Car with different learning rates in a similar manner to the study that we conducted for TD with random walk problem.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">MountainCarTiledCompare_n</span><span class="p">(</span><span class="n">runs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ntilings</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>  <span class="n">env</span><span class="o">=</span><span class="n">IHTtiledMountainCar</span><span class="p">):</span> <span class="c1"># 10</span>

    <span class="n">xsticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">.5</span> <span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">2.3</span><span class="p">])</span><span class="o">/</span><span class="n">ntilings</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="n">xsticks</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">xsticks</span><span class="o">*</span><span class="n">ntilings</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([</span><span class="mi">220</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">260</span><span class="p">,</span> <span class="mi">280</span><span class="p">,</span> <span class="mi">300</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">210</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Steps per episode averaged over first 50 episodes&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="n">αs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">.4</span><span class="p">,</span>  <span class="mf">1.8</span><span class="p">,</span>  <span class="mf">.1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="n">αs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">.2</span><span class="p">,</span>  <span class="mf">1.8</span><span class="p">,</span>  <span class="mf">.1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="n">αs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">.1</span><span class="p">,</span>  <span class="mf">1.8</span><span class="p">,</span>  <span class="mf">.1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span> <span class="n">αs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">.1</span><span class="p">,</span>  <span class="mf">1.2</span><span class="p">,</span>  <span class="mf">.07</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span> <span class="n">αs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">.1</span><span class="p">,</span>  <span class="mf">1.0</span><span class="p">,</span>  <span class="mf">.07</span><span class="p">)</span>

        <span class="n">Compare</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">Sarsan</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">(</span><span class="n">ntiles</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ntilings</span><span class="o">=</span><span class="n">ntilings</span><span class="p">),</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">,</span> <span class="n">episodes</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">ε</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">runs</span><span class="o">=</span><span class="n">runs</span><span class="p">,</span> 
                                  <span class="n">hyper</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;α&#39;</span><span class="p">:</span><span class="n">αs</span><span class="o">/</span><span class="n">ntilings</span><span class="p">},</span> 
                                  <span class="n">plotT</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">-step Sarsa&#39;</span><span class="o">%</span><span class="mi">2</span><span class="o">**</span><span class="n">n</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\alpha \times 8$ since we used 8 tiles for each tilings&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">figure_10_4_n</span> <span class="o">=</span> <span class="n">MountainCarTiledCompare_n</span>
</code></pre></div>
<p>Note that we always divided the learning rates αs by ntilings to match the amount of changes for different number of tilings so that we end up with an update magnitude that is compatible with a one-hot encoding.</p>
<div class="highlight"><pre><span></span><code><span class="o">%</span><span class="n">time</span> <span class="n">MountainCarTiledCompare_n</span><span class="p">()</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>100%|[92m██████████████████████████████████████████████████████████████████████████████████████████[0m|14/14
100%|[92m██████████████████████████████████████████████████████████████████████████████████████████[0m|16/16
100%|[92m██████████████████████████████████████████████████████████████████████████████████████████[0m|17/17
100%|[92m██████████████████████████████████████████████████████████████████████████████████████████[0m|16/16
100%|[92m██████████████████████████████████████████████████████████████████████████████████████████[0m|13/13
</code></pre></div>
<p><img alt="png" src="output_155_1.png" /></p>
<div class="highlight"><pre><span></span><code>CPU times: user 4min 51s, sys: 588 ms, total: 4min 52s
Wall time: 4min 52s
</code></pre></div>
<p>Note that we have not used hashing and hence our range is different from the one stated in the book. Nevertheless, the pattern is maintained.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this lesson, you saw how to deal with a continuous state space using function approximation and how to apply previous concepts to a more difficult control problem. We saw how to apply the tile coding technique we covered in the previous lesson on a continuous <em>control</em> Mountain car task. Along the way, we developed a new binary algorithm, Binary Sarsa, that is suitable for dealing with binary encoding, and we will study its performance. We present three representations of the problem. The first just discretised the space and used a vector representation that corresponds with this discretisation. This representation is equivalent to using one tiling in tile coding. Then we developed this representation to use multiple tiling that offset each other to enrich the representation capability for our continuous space. We then reduced the extra overhead introduced by the tile coding using hashing. We show that hashing is a powerful technique, and we studied a simple and efficient implementation of it. We concluded by updating our Sarsa(n) algorithm and applying it to the mountain car to compare its performance with different n. In the next lesson, we will show a new set of algorithms that achieve a similar or better performance without waiting for n steps.</p>
<h2 id="your-turn">Your turn</h2>
<ol>
<li>run the MountainCarTilings but this time fixed the divider on 8 (instead of dividing by ntilings), observe the results and compare them to the original experiments, post what you can infer in the group discussion.</li>
</ol>
<h2 id="challenge">Challenge</h2>
<ol>
<li>Implement a state rep that directly use the software library provided by the book <a href="(http://incompleteideas.net/tiles/tiles3.py-remove)">here</a>.</li>
<li>Can you think of a way to make the Mountain Car class works for the tabular case(assume that we have one tiling )</li>
</ol>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright Abdulrahman Altahhan
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.sections"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.f1b6f286.min.js"></script>
      
        <script src="../../javascript/tablecontentsoverride.js"></script>
      
        <script src="../../javascript/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js"></script>
      
        <script src="../../videos/my-video.mp4"></script>
      
    
  </body>
</html>